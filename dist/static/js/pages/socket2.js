window.onload=function(){var e=0,t=document.getElementsByTagName("html")[0],n=function(){var n=document.getElementById("MAIN_APP").getAttribute("ip_md5"),r=null,i="id"+n,s=document.getElementById("write_form"),o=document.getElementById("message"),u=document.getElementById("user_list"),a=s.getAttribute("host"),f=s.getAttribute("user"),l=document.getElementById("write_input"),c,h=!0,p=window.location.protocol,d=p==="https:"?"wss":"ws";f||(f=prompt("请输入你的昵称！"));var v=function(){var n;n=d+a;var r=new WebSocket(n);return r.addEventListener("open",function(){console.log("open")}),r.addEventListener("message",function(n){var r=n.data;try{r=JSON.parse(r)}catch(n){}switch(r.type){case"add to ul":var i=function(){var n=document.createElement("li");n.classList.add("each-message");var i='<span class="left username">'+r.user+":</span>"+'<span class="right content">'+r.msg+"</span>";n.innerHTML=i,o.appendChild(n),e++,t.classList.contains("hidden")&&(document.title="你有"+e+"条新消息喔～～")},s=function(){var e=function(){var e=document.createElement("li");e.classList.add("nowrap"),e.id=r.new_id,e.setAttribute("data-id",r.id),e.innerHTML=r.user,u.appendChild(e)},t=document.getElementById(r.new_id);if(t){t.getAttribute("data-id")!==r.id&&t.setAttribute("data-id",r.id);return}r.me==="me"?h&&(e(),document.getElementById(r.new_id).classList.add("me"),h=!1):e()};i(),s();break;case"remover person":var a=document.querySelector('[data-id="'+r.id+'"]');a&&a.remove()}}),r.addEventListener("close",function(){console.log("close"),setTimeout(function(){try{c=v(),console.log("reopen")}catch(e){}},1e3)}),r};c=v(),s.addEventListener("submit",function(e){f||(f=prompt("请输入你的昵称！")),f||(f="大傻逼");var t={type:"add message",user:f,msg:l.value};r=i+f,t.new_id=r,c.send(JSON.stringify(t)),l.value="",e.preventDefault()})};n(),document.addEventListener("visibilitychange",function(){var n=document.visibilityState;n==="hidden"&&(document.title="点我啊，草泥马！！",t.classList.contains("visible")&&t.classList.remove("visible"),t.classList.add("hidden"),e=0),n==="visible"&&(document.title=document.getElementById("MAIN_APP").getAttribute("title")+"--darlin.me",t.classList.contains("hidden")&&t.classList.remove("hidden"),t.classList.add("visible"))})};