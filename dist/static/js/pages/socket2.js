window.onload=function(){var e=0,t=document.getElementsByTagName("html")[0],n=function(){var n=null,r=(new Date).getTime()+Math.random(),i=document.getElementById("write_form"),s=document.getElementById("message"),o=document.getElementById("user_list"),u=i.getAttribute("host"),a=i.getAttribute("user"),f=document.getElementById("write_input"),l,c=!0,h=window.location.protocol,p=h==="https:"?"wss":"ws";a||(a=prompt("请输入你的昵称！"));var d=function(){var i;i=p+u;var a=new WebSocket(i);return a.addEventListener("open",function(){console.log("open")}),a.addEventListener("message",function(i){var u=i.data;try{u=JSON.parse(u)}catch(i){}switch(u.type){case"add to ul":var a=function(){var n=document.createElement("li");n.classList.add("each-message");var r='<span class="left username">'+u.user+":</span>"+'<span class="right content">'+u.msg+"</span>";n.innerHTML=r,s.appendChild(n),e++,t.classList.contains("hidden")&&(document.title="你有"+e+"条新消息喔～～")},f=function(){var e=function(){var e=document.createElement("li");e.classList.add("nowrap"),e.id=u.id,e.innerHTML=u.user,o.appendChild(e)};if(o.getElementsByClassName("me")[0])return;u.me==="me"?c&&(document.getElementById(u.id).classList.add("me"),n=u.id+r,c=!1):e()};u.me!=="me"&&a(),f();break;case"remover person":var l=document.getElementById(u.id);l&&l.remove()}}),a.addEventListener("close",function(){console.log("close"),setTimeout(function(){l=d(),console.log("reopen")},1e3)}),a};l=d(),i.addEventListener("submit",function(e){a||(a=prompt("请输入你的昵称！")),a||(a="大傻逼");var t={type:"add message",user:a,msg:f.value};n&&(t.id=n),l.send(JSON.stringify(t)),f.value="",e.preventDefault()})};n(),document.addEventListener("visibilitychange",function(){var n=document.visibilityState;n==="hidden"&&(document.title="点我啊，草泥马！！",t.classList.contains("visible")&&t.classList.remove("visible"),t.classList.add("hidden"),e=0),n==="visible"&&(document.title=document.getElementById("MAIN_APP").getAttribute("title")+"--darlin.me",t.classList.contains("hidden")&&t.classList.remove("hidden"),t.classList.add("visible"))})};