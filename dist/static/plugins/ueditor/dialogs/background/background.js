(function(){function initTabs(){var e=$G("tabHeads").children;for(var t=0;t<e.length;t++)domUtils.on(e[t],"click",function(t){var n=t.target||t.srcElement;for(var r=0;r<e.length;r++)if(e[r]==n){e[r].className="focus";var i=e[r].getAttribute("data-content-id");$G(i).style.display="block",i=="imgManager"&&initImagePanel()}else e[r].className="",$G(e[r].getAttribute("data-content-id")).style.display="none"})}function initColorSelector(){var e=editor.queryCommandValue("background");if(e){var t=e["background-color"],n=e["background-repeat"]||"repeat",r=e["background-image"]||"",i=e["background-position"]||"center center",s=i.split(" "),o=parseInt(s[0])||0,u=parseInt(s[1])||0;n=="no-repeat"&&(o||u)&&(n="self"),r=r.match(/url[\s]*\(([^\)]*)\)/),r=r?r[1]:"",updateFormState("colored",t,r,n,o,u)}else updateFormState();var a=function(){updateFormState(),updateBackground()};domUtils.on($G("nocolorRadio"),"click",updateBackground),domUtils.on($G("coloredRadio"),"click",a),domUtils.on($G("url"),"keyup",function(){$G("url").value&&$G("alignment").style.display=="none"&&utils.each($G("repeatType").children,function(e){e.selected="repeat"==e.getAttribute("value")?"selected":!1}),a()}),domUtils.on($G("repeatType"),"change",a),domUtils.on($G("x"),"keyup",updateBackground),domUtils.on($G("y"),"keyup",updateBackground),initColorPicker()}function initColorPicker(){var e=editor,t=$G("colorPicker"),n=new UE.ui.Popup({content:new UE.ui.ColorPicker({noColorText:e.getLang("clearColor"),editor:e,onpickcolor:function(e,t){updateFormState("colored",t),updateBackground(),UE.ui.Popup.postHide()},onpicknocolor:function(e,t){updateFormState("colored","transparent"),updateBackground(),UE.ui.Popup.postHide()}}),editor:e,onhide:function(){}});domUtils.on(t,"click",function(){n.showAnchor(this)}),domUtils.on(document,"mousedown",function(e){var t=e.target||e.srcElement;UE.ui.Popup.postHide(t)}),domUtils.on(window,"scroll",function(){UE.ui.Popup.postHide()})}function initImagePanel(){onlineImage=onlineImage||new OnlineImage("imageList")}function updateFormState(e,t,n,r,i,s){var o=$G("nocolorRadio"),u=$G("coloredRadio");e&&(o.checked=e=="colored"?!1:"checked",u.checked=e=="colored"?"checked":!1),t&&domUtils.setStyle($G("colorPicker"),"background-color",t);if(n&&/^\//.test(n)){var a=document.createElement("a");a.href=n,browser.ie&&(a.href=a.href),n=browser.ie?a.href:a.protocol+"//"+a.host+a.pathname+a.search+a.hash}if(n||n==="")$G("url").value=n;r&&utils.each($G("repeatType").children,function(e){e.selected=r==e.getAttribute("value")?"selected":!1});if(i||s)$G("x").value=parseInt(i)||0,$G("y").value=parseInt(s)||0;$G("alignment").style.display=u.checked&&$G("url").value?"":"none",$G("custom").style.display=u.checked&&$G("url").value&&$G("repeatType").value=="self"?"":"none"}function updateBackground(){if($G("coloredRadio").checked){var e=domUtils.getStyle($G("colorPicker"),"background-color"),t=$G("url").value,n=$G("repeatType").value,r={"background-repeat":"no-repeat","background-position":"center center"};e&&(r["background-color"]=e),t&&(r["background-image"]="url("+t+")");if(n=="self")r["background-position"]=$G("x").value+"px "+$G("y").value+"px";else if(n=="repeat-x"||n=="repeat-y"||n=="repeat")r["background-repeat"]=n;editor.execCommand("background",r)}else editor.execCommand("background",null)}function OnlineImage(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}var onlineImage,backupStyle=editor.queryCommandValue("background");window.onload=function(){initTabs(),initColorSelector()},OnlineImage.prototype={init:function(){this.reset(),this.initEvents()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.id="imageListUl",this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var e=this;domUtils.on($G("imageList"),"scroll",function(t){var n=this;n.scrollHeight-(n.offsetHeight+n.scrollTop)<10&&e.getImageData()}),domUtils.on(this.container,"click",function(e){var t=e.target||e.srcElement,n=t.parentNode,r=$G("imageListUl").childNodes;if(n.tagName.toLowerCase()=="li"){updateFormState("nocolor",null,"");for(var i=0,s;s=r[i++];)s==n&&!domUtils.hasClass(s,"selected")?(domUtils.addClass(s,"selected"),updateFormState("colored",null,n.firstChild.getAttribute("_src"),"repeat")):domUtils.removeClasses(s,"selected");updateBackground()}})},initData:function(){this.state=0,this.listSize=editor.getOpt("imageManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getImageData()},reset:function(){this.initContainer(),this.initData()},getImageData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData){this.isLoadingData=!0;var url=editor.getActionUrl(editor.getOpt("imageManagerActionName")),isJsonp=utils.isCrossDomainUrl(url);ajax.request(url,{timeout:1e5,dataType:isJsonp?"jsonp":"",data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=isJsonp?r:eval("("+r.responseText+")");json.state=="SUCCESS"&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){if(r.responseText.indexOf("ue_separate_ue")!=-1){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}})}},pushData:function(e){var t,n,r,i,s=this,o=editor.getOpt("imageManagerUrlPrefix");for(t=0;t<e.length;t++)e[t]&&e[t].url&&(n=document.createElement("li"),r=document.createElement("img"),i=document.createElement("span"),domUtils.on(r,"load",function(e){return function(){s.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(r)),r.width=113,r.setAttribute("src",o+e[t].url+(e[t].url.indexOf("?")==-1?"?noCache=":"&noCache=")+(+(new Date)).toString(36)),r.setAttribute("_src",o+e[t].url),domUtils.addClass(i,"icon"),n.appendChild(r),n.appendChild(i),this.list.insertBefore(n,this.clearFloat))},scale:function(e,t,n,r){var i=e.width,s=e.height;r=="justify"?i>=s?(e.width=t,e.height=n*s/i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t*i/s,e.height=n,e.style.marginTop="-"+parseInt((e.height-n)/2)+"px"):i>=s?(e.width=t*i/s,e.height=n,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=n*s/i,e.style.marginTop="-"+parseInt((e.height-n)/2)+"px")},getInsertList:function(){var e,t=this.list.children,n=[],r=getAlign();for(e=0;e<t.length;e++)if(domUtils.hasClass(t[e],"selected")){var i=t[e].firstChild,s=i.getAttribute("_src");n.push({src:s,_src:s,floatStyle:r})}return n}},dialog.onok=function(){updateBackground(),editor.fireEvent("saveScene")},dialog.oncancel=function(){editor.execCommand("background",backupStyle)}})();