function initChartsTypeView(){var e=[];for(var t=0,n=chartsConfig.length;t<n;t++)e.push('<div class="view-box" data-chart-type="'+t+'"><img width="300" src="images/charts'+t+'.png"></div>');$("#scrollBed").html(e.join(""))}function renderTable(e){var t=[];for(var n=0,r;r=e.rows[n];n++){tableData[n]=[],t[n]=[];for(var i=0,s;s=r.cells[i];i++){var o=getCellValue(s);n>0&&i>0&&(o=+o),n===0||i===0?t[n].push("<th>"+o+"</th>"):t[n].push('<td><input type="text" class="data-item" value="'+o+'"></td>'),tableData[n][i]=o}t[n]=t[n].join("")}$("#tableContainer").html('<table id="showTable" border="1"><tbody><tr>'+t.join("</tr><tr>")+"</tr></tbody></table>")}function initUserConfig(e){var t={};if(!e)return;e=e.split(";"),$.each(e,function(e,n){n=n.split(":"),t[n[0]]=n[1]}),setUserConfig(t)}function initEvent(){var e=null,t=chartsConfig.length-1,n=$("#scrollBed .view-box");$(".charts-format").delegate(".format-ctrl","change",function(){renderCharts()}),$(".table-view").delegate(".data-item","focus",function(){e=this.value}).delegate(".data-item","blur",function(){this.value!==e&&renderCharts(),e=null}),$("#buttonContainer").delegate("a","click",function(e){e.preventDefault(),this.getAttribute("data-title")==="prev"?currentChartType>0&&(currentChartType--,updateViewType(currentChartType)):currentChartType<t&&(currentChartType++,updateViewType(currentChartType))}),$("#scrollBed").delegate(".view-box","click",function(e){var t=$(this).attr("data-chart-type");n.removeClass("selected"),$(n[t]).addClass("selected"),currentChartType=t|0,currentChartType===chartsConfig.length-1?disableNotPieConfig():enableNotPieConfig(),renderCharts()})}function renderCharts(){var e=collectData();$("#chartsContainer").highcharts($.extend({},chartsConfig[currentChartType],{credits:{enabled:!1},exporting:{enabled:!1},title:{text:e.title,x:-20},subtitle:{text:e.subTitle,x:-20},xAxis:{title:{text:e.xTitle},categories:e.categories},yAxis:{title:{text:e.yTitle},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{enabled:!0,valueSuffix:e.suffix},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:1},series:e.series}))}function updateViewType(e){$("#scrollBed").css("marginLeft",-e*324+"px")}function collectData(){var e=document.forms["data-form"],t=null;return currentChartType!==chartsConfig.length-1?(t=getSeriesAndCategories(),$.extend(t,getUserConfig())):(t=getSeriesForPieChart(),t.title=e.title.value,t.suffix=e.unit.value),t}function getUserConfig(){var e=document.forms["data-form"],t={title:e.title.value,subTitle:e["sub-title"].value,xTitle:e["x-title"].value,yTitle:e["y-title"].value,suffix:e.unit.value,tableDataFormat:getTableDataFormat(),tip:$("#tipInput").val()};return t}function setUserConfig(e){var t=document.forms["data-form"];e.title&&(t.title.value=e.title),e.subTitle&&(t["sub-title"].value=e.subTitle),e.xTitle&&(t["x-title"].value=e.xTitle),e.yTitle&&(t["y-title"].value=e.yTitle),e.suffix&&(t.unit.value=e.suffix),e.dataFormat=="-1"&&(t["charts-format"][1].checked=!0),e.tip&&(t.tip.value=e.tip),currentChartType=e.chartType||0}function getSeriesAndCategories(){var e=document.forms["data-form"],t=[],n=[],r=[],i=getTableData();if(getTableDataFormat()==="-1"){for(var s=0,o=i.length;s<o;s++)for(var u=0,a=i[s].length;u<a;u++)r[u]||(r[u]=[]),r[u][s]=i[s][u];i=r}n=i[0].slice(1);for(var s=1,f;f=i[s];s++)t.push({name:f[0],data:f.slice(1)});return{series:t,categories:n}}function getTableDataFormat(){var e=document.forms["data-form"],t=e["charts-format"];return t[0].checked?t[0].value:t[1].value}function disableNotPieConfig(){updateConfigItem("disable")}function enableNotPieConfig(){updateConfigItem("enable")}function updateConfigItem(e){var t=$("#showTable")[0],n=e==="disable"?!0:!1;for(var r=2,i;i=t.rows[r];r++)for(var s=1,o;o=i.cells[s];s++)$("input",o).attr("disabled",n);$("input.not-pie-item").attr("disabled",n),$("#tipInput").attr("disabled",!n)}function getSeriesForPieChart(){var e={type:"pie",name:$("#tipInput").val(),data:[]},t=getTableData();for(var n=1,r=t[0].length;n<r;n++){var i=t[0][n],s=t[1][n];e.data.push([i,s])}return{series:[e]}}function getTableData(){var e=document.getElementById("showTable"),t=e.rows[0].cells.length-1,n=getTableInputValue();for(var r=0,i;i=n[r];r++)tableData[Math.floor(r/t)+1][r%t+1]=n[r];return tableData}function getTableInputValue(){var e=document.getElementById("showTable"),t=e.getElementsByTagName("input"),n=[];for(var r=0,i;i=t[r];r++)n.push(i.value|0);return n}function getCellValue(e){var t=utils.trim(e.innerText||e.textContent||"");return t.replace(new RegExp(UE.dom.domUtils.fillChar,"g"),"").replace(/^\s+|\s+$/g,"")}function syncTableData(){var e=getTableData();for(var t=1,n;n=editorTable.rows[t];t++)for(var r=1,i;i=n.cells[r];r++)i.innerHTML=e[t][r]}var tableData=[],editorTable=null,chartsConfig=window.typeConfig,resizeTimer=null,currentChartType=0;window.onload=function(){editorTable=domUtils.findParentByTagName(editor.selection.getRange().startContainer,"table",!0);if(!editorTable){document.body.innerHTML="<div class='edui-charts-not-data'>未找到数据</div>";return}initChartsTypeView(),renderTable(editorTable),initEvent(),initUserConfig(editorTable.getAttribute("data-chart")),$("#scrollBed .view-box:eq("+currentChartType+")").trigger("click"),updateViewType(currentChartType),dialog.addListener("resize",function(){resizeTimer!=null&&window.clearTimeout(resizeTimer),resizeTimer=window.setTimeout(function(){resizeTimer=null,renderCharts()},500)})},dialog.onok=function(){var e=document.forms["data-form"],t=getUserConfig();t.chartType=currentChartType,syncTableData(),editor.execCommand("charts",t)};