(function(){function initTabs(){var e=$G("tabhead").children;for(var t=0;t<e.length;t++)domUtils.on(e[t],"click",function(e){var t=e.target||e.srcElement;setTabFocus(t.getAttribute("data-content-id"))});setTabFocus("upload")}function setTabFocus(e){if(!e)return;var t,n,r=$G("tabhead").children;for(t=0;t<r.length;t++)n=r[t].getAttribute("data-content-id"),n==e?(domUtils.addClass(r[t],"focus"),domUtils.addClass($G(n),"focus")):(domUtils.removeClasses(r[t],"focus"),domUtils.removeClasses($G(n),"focus"));switch(e){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList")}}function initButtons(){dialog.onok=function(){var e=[],t,n=$G("tabhead").children;for(var r=0;r<n.length;r++)if(domUtils.hasClass(n[r],"focus")){t=n[r].getAttribute("data-content-id");break}switch(t){case"upload":e=uploadFile.getInsertList();var i=uploadFile.getQueueCount();if(i)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,i)+"</span>"),!1;break;case"online":e=onlineFile.getInsertList()}editor.execCommand("insertfile",e)}}function UploadFile(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}function OnlineFile(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}var uploadFile,onlineFile;window.onload=function(){initTabs(),initButtons()},UploadFile.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function x(e){var n=t('<li id="'+e.id+'">'+'<p class="title">'+e.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),r=t('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+"</span>"+'<span class="rotateRight">'+lang.uploadTurnRight+"</span>"+'<span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(n),i=n.find("p.progress span"),s=n.find("p.imgWrap"),o=t('<p class="error"></p>').hide().appendTo(n),u=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}o.text(text).show()};if(e.getStatus()==="invalid")u(e.statusText);else{s.text(lang.uploadPreview),"|png|jpg|jpeg|bmp|gif|".indexOf("|"+e.ext.toLowerCase()+"|")==-1?s.empty().addClass("notimage").append('<i class="file-preview file-type-'+e.ext.toLowerCase()+'"></i>'+'<span class="file-title" title="'+e.name+'">'+e.name+"</span>"):browser.ie&&browser.version<=7?s.text(lang.uploadNoPreview):b.makeThumb(e,function(e,n){if(e||!n)s.text(lang.uploadNoPreview);else{var r=t('<img src="'+n+'">');s.empty().append(r),r.on("error",function(){s.text(lang.uploadNoPreview)})}},d,v),g[e.id]=[e.size,0],e.rotation=0;if(!e.ext||S.indexOf(e.ext.toLowerCase())==-1)u("not_allow_type"),b.removeFile(e)}e.on("statuschange",function(t,s){s==="progress"?i.hide().width(0):s==="queued"&&(n.off("mouseenter mouseleave"),r.remove()),t==="error"||t==="invalid"?(u(e.statusText),g[e.id][1]=1):t==="interrupt"?u("interrupt"):t==="queued"?g[e.id][1]=0:t==="progress"?(o.hide(),i.css("display","block")):t==="complete",n.removeClass("state-"+s).addClass("state-"+t)}),n.on("mouseenter",function(){r.stop().animate({height:30})}),n.on("mouseleave",function(){r.stop().animate({height:0})}),r.on("click","span",function(){var n=t(this).index(),r;switch(n){case 0:b.removeFile(e);return;case 1:e.rotation+=90;break;case 2:e.rotation-=90}y?(r="rotate("+e.rotation+"deg)",s.css({"-webkit-transform":r,"-mos-transform":r,"-o-transform":r,transform:r})):s.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),n.insertBefore(a)}function T(e){var n=t("#"+e.id);delete g[e.id],N(),n.off().find(".file-panel").off().end().remove()}function N(){var e=0,n=0,r=l.children(),i;t.each(g,function(t,r){n+=r[0],e+=r[0]*r[1]}),i=n?e/n:0,r.eq(0).text(Math.round(i*100)+"%"),r.eq(1).css("width",Math.round(i*100)+"%"),k()}function C(t,n){if(t!=m){var u=b.getStats();o.removeClass("state-"+m),o.addClass("state-"+t);switch(t){case"pedding":r.addClass("element-invisible"),i.addClass("element-invisible"),f.removeClass("element-invisible"),l.hide(),s.hide(),b.refresh();break;case"ready":f.addClass("element-invisible"),r.removeClass("element-invisible"),i.removeClass("element-invisible"),l.hide(),s.show(),o.text(lang.uploadStart),b.refresh();break;case"uploading":l.show(),s.hide(),o.text(lang.uploadPause);break;case"paused":l.show(),s.hide(),o.text(lang.uploadContinue);break;case"confirm":l.show(),s.hide(),o.text(lang.uploadStart),u=b.getStats();if(u.successNum&&!u.uploadFailNum){C("finish");return}break;case"finish":l.hide(),s.show(),u.uploadFailNum?o.text(lang.uploadRetry):o.text(lang.uploadStart)}m=t,k()}e.getQueueCount()?o.removeClass("disabled"):o.addClass("disabled")}function k(){var e="",t;m==="ready"?e=lang.updateStatusReady.replace("_",c).replace("_KB",WebUploader.formatSize(h)):m==="confirm"?(t=b.getStats(),t.uploadFailNum&&(e=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum))):(t=b.getStats(),e=lang.updateStatusFinish.replace("_",c).replace("_KB",WebUploader.formatSize(h)).replace("_",t.successNum),t.uploadFailNum&&(e+=lang.updateStatusError.replace("_",t.uploadFailNum))),s.html(e)}var e=this,t=jQuery,n=e.$wrap,r=n.find(".filelist"),i=n.find(".statusBar"),s=i.find(".info"),o=n.find(".uploadBtn"),u=n.find(".filePickerBtn"),a=n.find(".filePickerBlock"),f=n.find(".placeholder"),l=i.find(".progress").hide(),c=0,h=0,p=window.devicePixelRatio||1,d=113*p,v=113*p,m="",g={},y=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,t}(),b,w=editor.getActionUrl(editor.getOpt("fileActionName")),E=editor.getOpt("fileMaxSize"),S=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");if(!WebUploader.Uploader.support()){t("#filePickerReady").after(t("<div>").html(lang.errorNotSupport)).hide();return}if(!editor.getOpt("fileActionName")){t("#filePickerReady").after(t("<div>").html(lang.errorLoadConfig)).hide();return}b=e.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:w,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:E,compress:!1}),b.addButton({id:"#filePickerBlock"}),b.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),C("pedding"),b.on("fileQueued",function(e){c++,h+=e.size,c===1&&(f.addClass("element-invisible"),i.show()),x(e)}),b.on("fileDequeued",function(e){c--,h-=e.size,T(e),N()}),b.on("filesQueued",function(e){!b.isInProgress()&&(m=="pedding"||m=="finish"||m=="confirm"||m=="ready")&&C("ready"),N()}),b.on("all",function(e,t){switch(e){case"uploadFinished":C("confirm",t);break;case"startUpload":var n=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",r=utils.formatUrl(w+(w.indexOf("?")==-1?"?":"&")+"encode=utf-8&"+n);b.option("server",r),C("uploading",t);break;case"stopUpload":C("paused",t)}}),b.on("uploadBeforeSend",function(e,t,n){n.X_Requested_With="XMLHttpRequest"}),b.on("uploadProgress",function(e,n){var r=t("#"+e.id),i=r.find(".progress span");i.css("width",n*100+"%"),g[e.id][1]=n,N()}),b.on("uploadSuccess",function(n,r){var i=t("#"+n.id);try{var s=r._raw||r,o=utils.str2json(s);o.state=="SUCCESS"?(e.fileList.push(o),i.append('<span class="success"></span>')):i.find(".error").text(o.state).show()}catch(u){i.find(".error").text(lang.errorServerUpload).show()}}),b.on("uploadError",function(e,t){}),b.on("error",function(e,t){(e=="Q_TYPE_DENIED"||e=="F_EXCEED_SIZE")&&x(t)}),b.on("uploadComplete",function(e,t){}),o.on("click",function(){if(t(this).hasClass("disabled"))return!1;m==="ready"?b.upload():m==="paused"?b.upload():m==="uploading"&&b.stop()}),o.addClass("state-"+m),N()},getQueueCount:function(){var e,t,n,r=0,i=this.uploader.getFiles();for(t=0;e=i[t++];)n=e.getStatus(),(n=="queued"||n=="uploading"||n=="progress")&&r++;return r},getInsertList:function(){var e,t,n,r=[],i=editor.getOpt("fileUrlPrefix");for(e=0;e<this.fileList.length;e++)n=this.fileList[e],t=n.url,r.push({title:n.original||t.substr(t.lastIndexOf("/")+1),url:i+t});return r}},OnlineFile.prototype={init:function(){this.initContainer(),this.initEvents(),this.initData()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var e=this;domUtils.on($G("fileList"),"scroll",function(t){var n=this;n.scrollHeight-(n.offsetHeight+n.scrollTop)<10&&e.getFileData()}),domUtils.on(this.list,"click",function(e){var t=e.target||e.srcElement,n=t.parentNode;n.tagName.toLowerCase()=="li"&&(domUtils.hasClass(n,"selected")?domUtils.removeClasses(n,"selected"):domUtils.addClass(n,"selected"))})},initData:function(){this.state=0,this.listSize=editor.getOpt("fileManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getFileData()},getFileData:function(){var _this=this;!_this.listEnd&&!this.isLoadingData&&(this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");json.state=="SUCCESS"&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){if(r.responseText.indexOf("ue_separate_ue")!=-1){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}}))},pushData:function(e){var t,n,r,i,s,o,u=this,a=editor.getOpt("fileManagerUrlPrefix");for(t=0;t<e.length;t++)if(e[t]&&e[t].url){n=document.createElement("li"),o=document.createElement("span"),i=e[t].url.substr(e[t].url.lastIndexOf(".")+1);if("png|jpg|jpeg|gif|bmp".indexOf(i)!=-1)s=document.createElement("img"),domUtils.on(s,"load",function(e){return function(){u.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(s)),s.width=113,s.setAttribute("src",a+e[t].url+(e[t].url.indexOf("?")==-1?"?noCache=":"&noCache=")+(+(new Date)).toString(36));else{var f=document.createElement("i"),l=document.createElement("span");l.innerHTML=e[t].url.substr(e[t].url.lastIndexOf("/")+1),s=document.createElement("div"),s.appendChild(f),s.appendChild(l),domUtils.addClass(s,"file-wrapper"),domUtils.addClass(l,"file-title"),domUtils.addClass(f,"file-type-"+i),domUtils.addClass(f,"file-preview")}domUtils.addClass(o,"icon"),n.setAttribute("data-url",a+e[t].url),e[t].original&&n.setAttribute("data-title",e[t].original),n.appendChild(s),n.appendChild(o),this.list.insertBefore(n,this.clearFloat)}},scale:function(e,t,n,r){var i=e.width,s=e.height;r=="justify"?i>=s?(e.width=t,e.height=n*s/i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t*i/s,e.height=n,e.style.marginTop="-"+parseInt((e.height-n)/2)+"px"):i>=s?(e.width=t*i/s,e.height=n,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=n*s/i,e.style.marginTop="-"+parseInt((e.height-n)/2)+"px")},getInsertList:function(){var e,t=this.list.children,n=[];for(e=0;e<t.length;e++)if(domUtils.hasClass(t[e],"selected")){var r=t[e].getAttribute("data-url"),i=t[e].getAttribute("data-title")||r.substr(r.lastIndexOf("/")+1);n.push({title:i,url:r})}return n}}})();