/*
 Map plugin v0.1 for Highcharts

 (c) 2011-2013 Torstein HÃ¸nsi

 License: www.highcharts.com/license
*/

(function(e){function t(e,t,n){for(var r=4,i=[];r--;)i[r]=Math.round(t.rgba[r]+(e.rgba[r]-t.rgba[r])*(1-n));return"rgba("+i.join(",")+")"}var n=e.Axis,r=e.Chart,i=e.Point,s=e.Pointer,o=e.each,u=e.extend,a=e.merge,f=e.pick,l=e.numberFormat,c=e.getOptions(),h=e.seriesTypes,p=c.plotOptions,d=e.wrap,v=e.Color,m=function(){};c.mapNavigation={buttonOptions:{align:"right",verticalAlign:"bottom",x:0,width:18,height:18,style:{fontSize:"15px",fontWeight:"bold",textAlign:"center"}},buttons:{zoomIn:{onclick:function(){this.mapZoom(.5)},text:"+",y:-32},zoomOut:{onclick:function(){this.mapZoom(2)},text:"-",y:0}}},e.splitPath=function(e){var t,e=e.replace(/([A-Za-z])/g," $1 "),e=e.replace(/^\s*/,"").replace(/\s*$/,""),e=e.split(/[ ,]+/);for(t=0;t<e.length;t++)/[a-zA-Z]/.test(e[t])||(e[t]=parseFloat(e[t]));return e},e.maps={},d(n.prototype,"getSeriesExtremes",function(e){var t=this.isXAxis,n,r,i=[];o(this.series,function(e,t){e.useMapGeometry&&(i[t]=e.xData,e.xData=[])}),e.call(this),n=f(this.dataMin,Number.MAX_VALUE),r=f(this.dataMax,Number.MIN_VALUE),o(this.series,function(e,s){e.useMapGeometry&&(n=Math.min(n,e[t?"minX":"minY"]),r=Math.max(r,e[t?"maxX":"maxY"]),e.xData=i[s])}),this.dataMin=n,this.dataMax=r}),d(n.prototype,"setAxisTranslation",function(e){var t=this.chart,n=t.plotWidth/t.plotHeight,r=this.isXAxis,i=t.xAxis[0];e.call(this),t.options.chart.type==="map"&&!r&&i.transA!==void 0&&(this.transA=i.transA=Math.min(this.transA,i.transA),e=(i.max-i.min)/(this.max-this.min),i=e>n?this:i,n=(i.max-i.min)*i.transA,i.minPixelPadding=(i.len-n)/2)}),d(r.prototype,"render",function(t){var n=this,r=n.options.mapNavigation;t.call(n),n.renderMapNavigation(),r.zoomOnDoubleClick&&e.addEvent(n.container,"dblclick",function(e){n.pointer.onContainerDblClick(e)}),r.zoomOnMouseWheel&&e.addEvent(n.container,document.onmousewheel===void 0?"DOMMouseScroll":"mousewheel",function(e){n.pointer.onContainerMouseWheel(e)})}),u(s.prototype,{onContainerDblClick:function(e){var t=this.chart,e=this.normalize(e);t.isInsidePlot(e.chartX-t.plotLeft,e.chartY-t.plotTop)&&t.mapZoom(.5,t.xAxis[0].toValue(e.chartX),t.yAxis[0].toValue(e.chartY))},onContainerMouseWheel:function(e){var t=this.chart,n,e=this.normalize(e);n=e.detail||-(e.wheelDelta/120),t.isInsidePlot(e.chartX-t.plotLeft,e.chartY-t.plotTop)&&t.mapZoom(n>0?2:.5,t.xAxis[0].toValue(e.chartX),t.yAxis[0].toValue(e.chartY))}}),d(s.prototype,"init",function(e,t,n){e.call(this,t,n),n.mapNavigation.enableTouchZoom&&(this.pinchX=this.pinchHor=this.pinchY=this.pinchVert=!0)}),u(r.prototype,{renderMapNavigation:function(){var e=this,t=this.options.mapNavigation,n=t.buttons,r,i,s,o=function(){this.handler.call(e)};if(t.enableButtons)for(r in n)n.hasOwnProperty(r)&&(s=a(t.buttonOptions,n[r]),i=e.renderer.button(s.text,0,0,o).attr({width:s.width,height:s.height}).css(s.style).add(),i.handler=s.onclick,i.align(u(s,{width:i.width,height:i.height}),null,"spacingBox"))},fitToBox:function(e,t){return o([["x","width"],["y","height"]],function(n){var r=n[0],n=n[1];e[r]+e[n]>t[r]+t[n]&&(e[n]>t[n]?(e[n]=t[n],e[r]=t[r]):e[r]=t[r]+t[n]-e[n]),e[n]>t[n]&&(e[n]=t[n]),e[r]<t[r]&&(e[r]=t[r])}),e},mapZoom:function(e,t,n){if(!this.isMapZooming){var r=this,i=r.xAxis[0],s=i.max-i.min,o=f(t,i.min+s/2),t=s*e,s=r.yAxis[0],u=s.max-s.min,n=f(n,s.min+u/2);e*=u,o-=t/2,u=n-e/2,n=f(r.options.chart.animation,!0),t=r.fitToBox({x:o,y:u,width:t,height:e},{x:i.dataMin,y:s.dataMin,width:i.dataMax-i.dataMin,height:s.dataMax-s.dataMin}),i.setExtremes(t.x,t.x+t.width,!1),s.setExtremes(t.y,t.y+t.height,!1);if(i=n?n.duration||500:0)r.isMapZooming=!0,setTimeout(function(){r.isMapZooming=!1},i);r.redraw()}}}),p.map=a(p.scatter,{animation:!1,nullColor:"#F8F8F8",borderColor:"silver",borderWidth:1,marker:null,stickyTracking:!1,dataLabels:{verticalAlign:"middle"},turboThreshold:0,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.y}<br/>"},states:{normal:{animation:!0}}}),n=e.extendClass(i,{applyOptions:function(t,n){var r=i.prototype.applyOptions.call(this,t,n);return r.path&&typeof r.path=="string"&&(r.path=r.options.path=e.splitPath(r.path)),r},onMouseOver:function(){clearTimeout(this.colorInterval),i.prototype.onMouseOver.call(this)},onMouseOut:function(){var e=this,n=+(new Date),r=v(e.options.color),s=v(e.pointAttr.hover.fill),o=e.series.options.states.normal.animation,u=o&&(o.duration||500);u&&r.rgba.length===4&&s.rgba.length===4&&(delete e.pointAttr[""].fill,clearTimeout(e.colorInterval),e.colorInterval=setInterval(function(){var i=(new Date-n)/u,o=e.graphic;i>1&&(i=1),o&&o.attr("fill",t(s,r,i)),i>=1&&clearTimeout(e.colorInterval)},13)),i.prototype.onMouseOut.call(e)}}),h.map=e.extendClass(h.scatter,{type:"map",pointAttrToOptions:{stroke:"borderColor","stroke-width":"borderWidth",fill:"color"},colorKey:"y",pointClass:n,trackerGroups:["group","markerGroup","dataLabelsGroup"],getSymbol:m,supportsDrilldown:!0,getExtremesFromAll:!0,useMapGeometry:!0,init:function(t){var n=this,r=t.options.legend.valueDecimals,i=[],s,u,a,f,c,p,d;p=t.options.legend.layout==="horizontal",e.Series.prototype.init.apply(this,arguments),c=n.options.colorRange,(f=n.options.valueRanges)?(o(f,function(t){u=t.from,a=t.to,s="",u===void 0?s="< ":a===void 0&&(s="> "),u!==void 0&&(s+=l(u,r)),u!==void 0&&a!==void 0&&(s+=" - "),a!==void 0&&(s+=l(a,r)),i.push(e.extend({chart:n.chart,name:s,options:{},drawLegendSymbol:h.area.prototype.drawLegendSymbol,visible:!0,setState:function(){},setVisible:function(){}},t))}),n.legendItems=i):c&&(u=c.from,a=c.to,f=c.fromLabel,c=c.toLabel,d=p?[0,0,1,0]:[0,1,0,0],p||(p=f,f=c,c=p),p={linearGradient:{x1:d[0],y1:d[1],x2:d[2],y2:d[3]},stops:[[0,u],[1,a]]},i=[{chart:n.chart,options:{},fromLabel:f,toLabel:c,color:p,drawLegendSymbol:this.drawLegendSymbolGradient,visible:!0,setState:function(){},setVisible:function(){}}],n.legendItems=i)},drawLegendSymbol:h.area.prototype.drawLegendSymbol,drawLegendSymbolGradient:function(e,t){var n=e.options.symbolPadding,r=f(e.options.padding,8),i,s,o=this.chart.renderer.fontMetrics(e.options.itemStyle.fontSize).h,u=e.options.layout==="horizontal",a;a=f(e.options.rectangleLength,200),u?(i=-(n/2),s=0):(i=-a+e.baseline-n/2,s=r+o),t.fromText=this.chart.renderer.text(t.fromLabel,s,i).attr({zIndex:2}).add(t.legendGroup),s=t.fromText.getBBox(),t.legendSymbol=this.chart.renderer.rect(u?s.x+s.width+n:s.x-o-n,s.y,u?a:o,u?o:a,2).attr({zIndex:1}).add(t.legendGroup),a=t.legendSymbol.getBBox(),t.toText=this.chart.renderer.text(t.toLabel,a.x+a.width+n,u?i:a.y+a.height-n).attr({zIndex:2}).add(t.legendGroup),i=t.toText.getBBox(),u?(e.offsetWidth=s.width+a.width+i.width+n*2+r,e.itemY=o+r):(e.offsetWidth=Math.max(s.width,i.width)+n+a.width+r,e.itemY=a.height+r,e.itemX=n)},getBox:function(e){var t=Number.MIN_VALUE,n=Number.MAX_VALUE,r=Number.MIN_VALUE,i=Number.MAX_VALUE;o(e||this.options.data,function(e){for(var s=e.path,o=s.length,u=!1,a=Number.MIN_VALUE,f=Number.MAX_VALUE,l=Number.MIN_VALUE,c=Number.MAX_VALUE;o--;)typeof s[o]=="number"&&!isNaN(s[o])&&(u?(a=Math.max(a,s[o]),f=Math.min(f,s[o])):(l=Math.max(l,s[o]),c=Math.min(c,s[o])),u=!u);e._maxX=a,e._minX=f,e._maxY=l,e._minY=c,t=Math.max(t,a),n=Math.min(n,f),r=Math.max(r,l),i=Math.min(i,c)}),this.minY=i,this.maxY=r,this.minX=n,this.maxX=t},translatePath:function(e){var t=!1,n=this.xAxis,r=this.yAxis,i,e=[].concat(e);for(i=e.length;i--;)typeof e[i]=="number"&&(e[i]=t?Math.round(n.translate(e[i])):Math.round(r.len-r.translate(e[i])),t=!t);return e},setData:function(){e.Series.prototype.setData.apply(this,arguments),this.getBox()},translate:function(){var e=this,t=Number.MAX_VALUE,n=Number.MIN_VALUE;e.generatePoints(),o(e.data,function(r){r.shapeType="path",r.shapeArgs={d:e.translatePath(r.path)},typeof r.y=="number"&&(r.y>n?n=r.y:r.y<t&&(t=r.y))}),e.translateColors(t,n)},translateColors:function(e,n){var r=this.options,i=r.valueRanges,s=r.colorRange,u=this.colorKey,a,f;s&&(a=v(s.from),f=v(s.to)),o(this.data,function(o){var l=o[u],c,h,p;if(i){for(p=i.length;p--;)if(c=i[p],a=c.from,f=c.to,(a===void 0||l>=a)&&(f===void 0||l<=f)){h=c.color;break}}else s&&l!==void 0&&(c=1-(n-l)/(n-e),h=l===null?r.nullColor:t(a,f,c));h&&(o.color=null,o.options.color=h)})},drawGraph:m,drawDataLabels:m,drawPoints:function(){var t=this.xAxis,n=this.yAxis,r=this.colorKey;o(this.data,function(e){e.plotY=1,e[r]===null&&(e[r]=0,e.isNull=!0)}),h.column.prototype.drawPoints.apply(this),o(this.data,function(e){var i=e.dataLabels,s=t.toPixels(e._minX,!0),o=t.toPixels(e._maxX,!0),u=n.toPixels(e._minY,!0),a=n.toPixels(e._maxY,!0);e.plotX=Math.round(s+(o-s)*f(i&&i.anchorX,.5)),e.plotY=Math.round(u+(a-u)*f(i&&i.anchorY,.5)),e.isNull&&(e[r]=null)}),e.Series.prototype.drawDataLabels.call(this)},animateDrilldown:function(e){var t=this.chart.plotBox,n=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],r=n.bBox,i=this.chart.options.drilldown.animation;e||(e=Math.min(r.width/t.width,r.height/t.height),n.shapeArgs={scaleX:e,scaleY:e,translateX:r.x,translateY:r.y},o(this.points,function(e){e.graphic.attr(n.shapeArgs).animate({scaleX:1,scaleY:1,translateX:0,translateY:0},i)}),delete this.animate)},animateDrillupFrom:function(e){h.column.prototype.animateDrillupFrom.call(this,e)},animateDrillupTo:function(e){h.column.prototype.animateDrillupTo.call(this,e)}}),p.mapline=a(p.map,{lineWidth:1,backgroundColor:"none"}),h.mapline=e.extendClass(h.map,{type:"mapline",pointAttrToOptions:{stroke:"color","stroke-width":"lineWidth",fill:"backgroundColor"},drawLegendSymbol:h.line.prototype.drawLegendSymbol}),p.mappoint=a(p.scatter,{dataLabels:{enabled:!0,format:"{point.name}",color:"black",style:{textShadow:"0 0 5px white"}}}),h.mappoint=e.extendClass(h.scatter,{type:"mappoint"}),e.Map=function(t,n){var r={endOnTick:!1,gridLineWidth:0,labels:{enabled:!1},lineWidth:0,minPadding:0,maxPadding:0,startOnTick:!1,tickWidth:0,title:null},i;return i=t.series,t.series=null,t=a({chart:{type:"map",panning:"xy"},xAxis:r,yAxis:a(r,{reversed:!0})},t,{chart:{inverted:!1}}),t.series=i,new e.Chart(t,n)}})(Highcharts);